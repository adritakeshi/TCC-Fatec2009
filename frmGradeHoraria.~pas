unit frmGradeHoraria;
//Tem que receber o valor do semestre do Aluno
interface

uses
  Windows, Messages, SysUtils, Variants, Classes, Graphics, Controls, Forms,
  Dialogs, StdCtrls, Grids, Buttons, DB, ADODB, Horarios, Feagri;//CaminhoCritico_Yu;

type
  TFGrade = class(TForm)
    Label1: TLabel;
    BitBtn1: TBitBtn;
    BitBtn2: TBitBtn;
    StringGrid1: TStringGrid;
    Label2: TLabel;
    Label3: TLabel;
    procedure StringGrid1DrawCell(Sender: TObject; ACol, ARow: Integer;
      Rect: TRect; State: TGridDrawState);
    procedure FormClose(Sender: TObject; var Action: TCloseAction);
    procedure StringGrid1SelectCell(Sender: TObject; ACol, ARow: Integer;
      var CanSelect: Boolean);
    procedure BitBtn1Click(Sender: TObject);
    procedure BitBtn2Click(Sender: TObject);
    procedure FormCreate(Sender: TObject);
    procedure SelecionaPrimeiraCelula;
    procedure VerificaPreReq;
  private
    { Private declarations }
  public
    { Public declarations }
  end;

var
  FGrade: TFGrade;
  Sem: integer;
  Hor: THorarios;
  CredSim: integer;
  ContCred: integer;
  Bloqueado: Boolean;
  CodSim: integer;



  //Simulacao e Materia a simular devem ser variáveis da tela do Yanagui
  Simulacao: boolean;
  MatSim: String;
  Dispensa: Array of RMateria;

implementation

uses principal, Builder;

{$R *.dfm}

procedure TFGrade.FormCreate(Sender: TObject);
var i, j, k: integer;
begin
  //APAGAR DEPOIS AS QUATRO PROXIMAS LINHAS
  Simulacao := Builder.Simula;
  MatSim := Builder.MatSimulacao;
  Sem := Builder.origem;

  //Mat.SemestreFeagri[1].Consolidado := true;
  //Mat.SemestreFeagri[2].Trancado := true;
  //Mat.SemestreFeagri[3].Travado := true;

//  FGrade.FormStyle:= fsMDIChild;
//  FGrade.Width := 563;
//  FGrade.Height := 422;

  label1.Font.Height := 20;
  label1.Left := 185;
  label1.Top := 35;

  Bitbtn1.Caption := '<';
  Bitbtn1.Width := 25;
  Bitbtn1.Left := 144;
  Bitbtn1.Top := 32;

  Bitbtn2.Caption := '>';
  Bitbtn2.Width := 25;
  Bitbtn2.Left := 376;
  Bitbtn2.Top := 32;

  StringGrid1.Left := 25;
  StringGrid1.Top := 88;

  Label1.Caption := 'Horário do ' + IntToStr(Sem) + 'º Semestre';

  if Sem = 1 then
    bitbtn1.Enabled := false;

  StringGrid1.Cells[1,0] := 'Segunda-feira';
  StringGrid1.Cells[2,0] := '   Terça-feira';
  StringGrid1.Cells[3,0] := '  Quarta-feira';
  StringGrid1.Cells[4,0] := '  Quinta-feira';
  StringGrid1.Cells[5,0] := '   Sexta-feira';
  StringGrid1.Cells[6,0] := '    Sábado';

  StringGrid1.Cells[0,1] := '  07:00';
  StringGrid1.Cells[0,2] := '  08:00';
  StringGrid1.Cells[0,3] := '  09:00';
  StringGrid1.Cells[0,4] := '  10:00';
  StringGrid1.Cells[0,5] := '  11:00';

  StringGrid1.Cells[0,7] := '  14:00';
  StringGrid1.Cells[0,8] := '  15:00';
  StringGrid1.Cells[0,9] := '  16:00';
  StringGrid1.Cells[0,10] := '  17:00';
  StringGrid1.Cells[0,11] := '  18:00';

  StringGrid1.Cells[0,13] := '  19:00';
  StringGrid1.Cells[0,14] := '  20:00';
  StringGrid1.Cells[0,15] := '  21:00';
  StringGrid1.Cells[0,16] := '  22:00';

  SelecionaPrimeiraCelula;

  if Simulacao = true then
  begin
    for i:= 0 to (high(Builder.Catalogo.SemestreFeagri)-1) do
      for j := 1 to 15 do
      begin
        if MatSim = Builder.Catalogo.SemestreFeagri[i].MateriaSemestre[j].Legenda then
        begin
          CredSim := Builder.Catalogo.SemestreFeagri[i].MateriaSemestre[j].Credito;
          ContCred := CredSim;
        end;
      end;

//    FGrade.Height := FGrade.Height + 50;
    label1.Top := label1.Top + 50;
    Bitbtn1.Top := Bitbtn1.Top + 50;
    Bitbtn2.Top := Bitbtn2.Top + 50;
    StringGrid1.Top := StringGrid1.Top + 50;

    Label2.Caption := 'Simulação da Matéria: ' + MatSim;
    label2.Font.Height := 20;
    Label2.Left := 96;
    Label2.Top := 35;
    Label2.Visible := true;

    Label3.Caption := 'Crédito: ' + IntToStr(CredSim);
    label3.Font.Height := 20;
    Label3.Left := 352;
    Label3.Top := 35;
    Label3.Visible := true;
  end
  else
  begin
    Label2.Visible := false;
    Label3.Visible := false;
  end;

  if Hor = nil then
    Hor := THorarios.Create(FormPrincipal.AluRA, 2007)
  else
  begin
    for i := 0 to (high(Builder.Catalogo.SemestreFeagri)-1) do
      for j := 2 to 7 do
        for k := 1 to 16 do
          if (Hor.GradeSim[i].Semana[j].Hora[k] = MatSim) then
            Dec(ContCred);
  end;



  for i:= low(Builder.Catalogo.SemestreFeagri) to (High(Builder.Catalogo.SemestreFeagri)) do
    for j:= 1 to (High(Builder.Catalogo.SemestreFeagri[1].MateriaSemestre)) do
      if Builder.Catalogo.SemestreFeagri[i].MateriaSemestre[j].Legenda = MatSim then
        CodSim := Builder.Catalogo.SemestreFeagri[i].MateriaSemestre[j].Codigo;

  Hor.PreencheHorarioNormal(StringGrid1, Sem, MatSim);
  Hor.PreencheHorarioSimulado(StringGrid1, Sem);
  VerificaPreReq;

end;

procedure TFGrade.SelecionaPrimeiraCelula;
var MyRect: TGridRect;
begin
  MyRect.Left:=0; // coluna inicial
  MyRect.Right:=0; // coluna final
  MyRect.Top:=0; // linha inicial
  MyRect.Bottom:=0; // linha final
  stringGrid1.Selection:=MyRect;
end;

procedure TFGrade.BitBtn1Click(Sender: TObject);
begin
  bitbtn2.Enabled := true;
  SelecionaPrimeiraCelula;
  if Sem > 1 then
    dec(Sem);

  if Sem = 1 then
    bitbtn1.Enabled := false;

  Label1.Caption := 'Horário do ' + IntToStr(Sem) + 'º Semestre';

  Hor.PreencheHorarioNormal(StringGrid1, Sem, MatSim);
  Hor.PreencheHorarioSimulado(StringGrid1, Sem);
  VerificaPreReq;


end;

procedure TFGrade.BitBtn2Click(Sender: TObject);
begin
  bitbtn1.Enabled := true;
  SelecionaPrimeiraCelula;

  if Sem < (high(Builder.Catalogo.SemestreFeagri)-1) then
    inc(Sem);

  if Sem = (high(Builder.Catalogo.SemestreFeagri)-1) then
    bitbtn2.Enabled := false;

  Label1.Caption := 'Horário do ' + IntToStr(Sem) + 'º Semestre';

  Hor.PreencheHorarioNormal(StringGrid1, Sem, MatSim);
  Hor.PreencheHorarioSimulado(StringGrid1, Sem);
  VerificaPreReq;

end;

procedure TFGrade.StringGrid1SelectCell(Sender: TObject; ACol, ARow: Integer;
  var CanSelect: Boolean);
var i, j, k: integer;
begin

  //Se não for simulação, sai
  if Simulacao = false then
    exit;

  //Se for em horario que nao tem aula, sai
  if (ARow = 6) or (ARow = 12) then
    exit;

  //Se o semestre estiver consolidado, sai
  if Builder.Catalogo.SemestreFeagri[sem].Consolidado = true then
  begin
    ShowMessage('O ' + IntToStr(sem) + 'º semestre está consolidado');
    exit;
  end;

  //Se o semestre estiver trancado, sai
  if Builder.Catalogo.SemestreFeagri[sem].Trancado = true then
  begin
    ShowMessage('O ' + IntToStr(sem) + 'º semestre está trancado');
    exit;
  end;

  //Se o semestre estiver travado, sai
  if Builder.Catalogo.SemestreFeagri[sem].Travado = true then
  begin
    ShowMessage('O ' + IntToStr(sem) + 'º semestre está travado');
    exit;
  end;

  //Se não puder cursar a matéria por causa de pré-requisito, sai
  if Bloqueado = true then
  begin
    ShowMessage('A matéria ' + MatSim + ' depende de pré-requisito(s) para' +
      ' poder ser cursada no ' + IntToStr(sem) + 'º semestre');
    exit;
  end;

  //Se não tiver matéria, cria matéria simulada.
  if StringGrid1.Cells[ACol, ARow] = '' then
  begin
    for i := 0 to (High(Builder.Catalogo.SemestreFeagri)-1) do
      for j := 2 to 7 do
        for k := 1 to 16 do
          if (Hor.GradeSim[i].Semana[j].Hora[k] = MatSim) and (sem <> i) then
          begin
            ShowMessage('Essa matéria já está sendo simulada no ' +
              IntToStr(i) + 'º Semestre');
            exit;
          end;
    if ContCred <> 0 then
    begin
      Hor.GradeSim[sem].Semana[ACol+1].Hora[ARow] := MatSim;
      Hor.PreencheHorarioSimulado(StringGrid1, Sem);
      dec(ContCred);
    end
    else
      ShowMessage('A matéria ' + MatSim + ' já alcançou o limite de créditos');
  end
  else
    //Se já houver uma matéria simulada, deixar o espaço em branco
    if (Hor.GradeSim[sem].Semana[ACol+1].Hora[ARow] <> '') and
       (Hor.GradeSim[sem].Semana[ACol+1].Hora[ARow] = MatSim)then
    begin
      Hor.GradeSim[sem].Semana[ACol+1].Hora[ARow] := '';
      Hor.PreencheHorarioNormal(StringGrid1, Sem, MatSim);
      Hor.PreencheHorarioSimulado(StringGrid1, Sem);
      if ContCred < CredSim then
        inc(ContCred);
    end;
  //ShowMessage(StringGrid1.Cells[ACol, ARow]);

end;



procedure TFGrade.FormClose(Sender: TObject; var Action: TCloseAction);
begin
  if (ContCred = CredSim) or (ContCred = 0) then
  begin
    Hor.SalvaHorarios(MatSim, ContCred, CredSim);
    Builder.SimuOk := true;
    Action := cafree;
  end
  else
  begin
    ShowMessage('Ainda falta(m) ' + IntToStr(ContCred) + ' crédito(s) para a ' +
      'matéria ' + MatSim);
    Action := canone;
    Builder.SimuOk := false;
  end;
end;




procedure TFGrade.StringGrid1DrawCell(Sender: TObject; ACol, ARow: Integer;
  Rect: TRect; State: TGridDrawState);
Const
  //Defina a cor aqui
  clPaleGreen = TColor($F2E4D7);
begin
  if Hor = nil then
    exit;

  //Colorindo as matérias simuladas
  if Hor.GradeSim[Sem].Semana[ACol+1].Hora[ARow] <> '' then
    StringGrid1.Canvas.Brush.color := clPaleGreen
  else
    StringGrid1.Canvas.Brush.Color := clWhite;

  If (ACol > 0) and (ARow > 0) then
  begin
    //Pintando o Fundo
    StringGrid1.canvas.fillRect(Rect);
    //Pintando o Texto
    StringGrid1.canvas.TextOut(Rect.Left + 20, Rect.Top + 2, StringGrid1.Cells[ACol,ARow]);
  end;

end;

procedure TFGrade.VerificaPreReq();
begin
  if (PreReq.PodeCursar(Builder.Catalogo.SemestreFeagri, Dispensa, CodSim, Sem)) and
     (PreReq.PodeCursarPreRequisito(Builder.Catalogo.SemestreFeagri, CodSim, sem)) then
     Bloqueado := false
  else
     Bloqueado := true;

  if (PreReq.PodeCursar(Builder.Catalogo.SemestreFeagri, Dispensa, CodSim, Sem)) then
    ShowMessage('PodeCursar = true')
  else
    ShowMessage('PodeCursar = false');

  if (PreReq.PodeCursarPreRequisito(Builder.Catalogo.SemestreFeagri, CodSim, sem)) then
    ShowMessage('PodeCursarPreReq = true')
  else
    ShowMessage('PodeCursarPreReq = false');

  if Bloqueado then
    ShowMessage('Bloqueado = True')
  else
    ShowMessage('Bloqueado = False');

end;
{procedure TFGrade.Button1Click(Sender: TObject);
var m: RHorMat;
    i,j: Integer;
begin
  SetLength(m, 97);
  //m[0].DiaDaSemana := 2;
  //m[0].Hora := 4;

  j:=1;
  for i:= 1 to 16 do
  begin
    m[j].DiaDaSemana := 2;
    m[j].Hora := i;
    inc(j);
  end;

  For i:= 1 to 16 do
  begin
    m[j].DiaDaSemana := 3;
    m[j].Hora := i;
    inc(j);
  end;

  For i:= 1 to 16 do
  begin
    m[j].DiaDaSemana := 4;
    m[j].Hora := i;
    inc(j);
  end;

  For i:= 1 to 16 do
  begin
    m[j].DiaDaSemana := 5;
    m[j].Hora := i;
    inc(j);
  end;

  For i:= 1 to 16 do
  begin
    m[j].DiaDaSemana := 6;
    m[j].Hora := i;
    inc(j);
  end;

  For i:= 1 to 16 do
  begin
    m[j].DiaDaSemana := 7;
    m[j].Hora := i;
    inc(j);
  end;

  if Hor.BateHorario(1, m) = true then
    ShowMessage('Bate Horario!')
  else
   ShowMessage('Não Bate Horario!');
end;}


end.
